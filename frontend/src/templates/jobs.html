<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobs - Transcribo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .job-card {
            transition: transform 0.2s;
        }
        .job-card:hover {
            transform: translateY(-2px);
        }
        .status-badge {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
        .status-processing {
            background-color: #0dcaf0;
            color: #000;
        }
        .status-completed {
            background-color: #198754;
            color: #fff;
        }
        .status-failed {
            background-color: #dc3545;
            color: #fff;
        }
        .progress {
            height: 0.5rem;
            margin-top: 0.5rem;
        }
        .eta-text {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .job-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .job-card:hover .job-actions {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">Transcribo</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/upload">Upload</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/jobs">Jobs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/help">Help</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <div class="container mt-4">
        <!-- Filters -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="status-filter">
                        <option value="">All</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Language</label>
                    <select class="form-select" id="language-filter">
                        <option value="">All</option>
                        <option value="de">German</option>
                        <option value="en">English</option>
                        <option value="fr">French</option>
                        <option value="it">Italian</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" id="sort-by">
                        <option value="created_desc">Newest First</option>
                        <option value="created_asc">Oldest First</option>
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="search" placeholder="Search files...">
                </div>
            </div>
        </div>

        <!-- Jobs List -->
        <div class="row g-4" id="jobs-list">
            <!-- Job Card Template -->
            <template id="job-card-template">
                <div class="col-md-6">
                    <div class="card job-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title text-truncate mb-0" style="max-width: 70%;">
                                    <i class="bi bi-file-earmark-music me-2"></i>
                                    <span class="job-name"></span>
                                </h5>
                                <span class="badge status-badge"></span>
                            </div>
                            <div class="card-text">
                                <div class="d-flex justify-content-between mb-2">
                                    <small class="text-muted job-created"></small>
                                    <small class="text-muted job-language"></small>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar"
                                         style="width: 0%"></div>
                                </div>
                                <small class="eta-text d-block mt-2"></small>
                            </div>
                            <div class="job-actions mt-3">
                                <button class="btn btn-sm btn-outline-primary view-btn">
                                    <i class="bi bi-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-outline-danger cancel-btn">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                                <button class="btn btn-sm btn-outline-secondary download-btn">
                                    <i class="bi bi-download"></i> Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Loading Spinner -->
        <div class="text-center mt-4" id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- No Jobs Message -->
        <div class="text-center mt-4 d-none" id="no-jobs-message">
            <p class="text-muted">No jobs found. <a href="/upload">Upload some files</a> to get started.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));

        // Job status classes
        const statusClasses = {
            pending: 'status-pending',
            processing: 'status-processing',
            completed: 'status-completed',
            failed: 'status-failed'
        };

        // Format relative time
        function formatRelativeTime(date) {
            const now = new Date();
            const diff = now - new Date(date);
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        // Format file size
        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unit = 0;
            while (size >= 1024 && unit < units.length - 1) {
                size /= 1024;
                unit++;
            }
            return `${size.toFixed(1)} ${units[unit]}`;
        }

        // Create job card
        function createJobCard(job) {
            const template = document.getElementById('job-card-template');
            const card = template.content.cloneNode(true);

            // Set job details
            card.querySelector('.job-name').textContent = job.file_name;
            card.querySelector('.status-badge').textContent = job.status;
            card.querySelector('.status-badge').classList.add(statusClasses[job.status]);
            card.querySelector('.job-created').textContent = formatRelativeTime(job.created_at);
            card.querySelector('.job-language').textContent = job.language.toUpperCase();

            // Set progress
            const progressBar = card.querySelector('.progress-bar');
            progressBar.style.width = `${job.progress || 0}%`;
            progressBar.setAttribute('aria-valuenow', job.progress || 0);

            // Set ETA
            if (job.eta) {
                card.querySelector('.eta-text').textContent = 
                    `Estimated completion: ${new Date(job.eta).toLocaleTimeString()}`;
            }

            // Setup buttons
            const viewBtn = card.querySelector('.view-btn');
            viewBtn.onclick = () => window.location.href = `/jobs/${job.id}`;

            const cancelBtn = card.querySelector('.cancel-btn');
            cancelBtn.onclick = () => cancelJob(job.id);
            cancelBtn.style.display = ['pending', 'processing'].includes(job.status) ? 'inline-block' : 'none';

            const downloadBtn = card.querySelector('.download-btn');
            downloadBtn.onclick = () => downloadTranscription(job.id);
            downloadBtn.style.display = job.status === 'completed' ? 'inline-block' : 'none';

            return card;
        }

        // Load jobs
        async function loadJobs() {
            const status = document.getElementById('status-filter').value;
            const language = document.getElementById('language-filter').value;
            const sort = document.getElementById('sort-by').value;
            const search = document.getElementById('search').value;

            try {
                const response = await fetch(
                    `/api/jobs?${new URLSearchParams({
                        status,
                        language,
                        sort,
                        search
                    })}`
                );
                const data = await response.json();

                const jobsList = document.getElementById('jobs-list');
                jobsList.innerHTML = '';

                if (data.jobs.length === 0) {
                    document.getElementById('no-jobs-message').classList.remove('d-none');
                } else {
                    document.getElementById('no-jobs-message').classList.add('d-none');
                    data.jobs.forEach(job => {
                        jobsList.appendChild(createJobCard(job));
                    });
                }
            } catch (error) {
                console.error('Failed to load jobs:', error);
            } finally {
                document.getElementById('loading-spinner').style.display = 'none';
            }
        }

        // Cancel job
        async function cancelJob(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    loadJobs();
                }
            } catch (error) {
                console.error('Failed to cancel job:', error);
            }
        }

        // Download transcription
        async function downloadTranscription(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}/download`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transcription_${jobId}.txt`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error('Failed to download transcription:', error);
            }
        }

        // Setup filters
        document.getElementById('status-filter').onchange = loadJobs;
        document.getElementById('language-filter').onchange = loadJobs;
        document.getElementById('sort-by').onchange = loadJobs;
        document.getElementById('search').oninput = debounce(loadJobs, 300);

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Auto-refresh jobs
        setInterval(loadJobs, 5000);

        // Initial load
        loadJobs();
    </script>
</body>
</html>
